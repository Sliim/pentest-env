# coding: utf-8
# This source file is part of pentest-env.
#
# pentest-env is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# pentest-env is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License along
# with pentest-env. If not, see <http://www.gnu.org/licenses/gpl-3.0.html>.

require File.expand_path('instance', File.dirname(__FILE__))
require File.expand_path('target', File.dirname(__FILE__))

class Pentestenv
  # Pentest-env Customizations
  class Customization
    def initialize(custom)
      @custom = custom
    end

    def targets(config)
      config_instances(config, 'targets')
    end

    def instances(config)
      config_instances(config)
    end

    def config_instances(config, type='instances')
      return unless @custom.key?(type)

      @custom[type].each do |i|
        if type == 'instances'
          instance = Pentestenv::Instance.new(config, i.chomp, @custom)
        else
          instance = Pentestenv::Target.new(config, i.chomp, @custom)
        end

        instance.register
        apply instance.name, config
      end
    end

    def apply(instance_name, config)
      packages instance_name, config
      commands instance_name, config
      scripts instance_name, config
      synced_folders instance_name, config

      apply_chef instance_name, config
    end

    def packages(instance_name, config)
      packages = instance_customization(instance_name.to_s, 'packages')
      return unless packages

      config.vm.provision :shell,
                          inline: 'apt-get update&&'\
                                  "apt-get -y install #{packages.join(' ')}"
    end

    def commands(instance_name, config)
      commands = instance_customization(instance_name.to_s, 'commands')
      return unless commands

      commands.each do |command|
        config.vm.provision :shell,
                            inline: command
      end
    end

    def scripts(instance_name, config)
      scripts = instance_customization(instance_name.to_s, 'scripts')
      return unless scripts

      scripts.each do |script|
        next unless script_path(script)
        config.vm.provision :shell,
                            path: script_path(script)
      end
    end

    def synced_folders(instance_name, config)
      folders = instance_customization(instance_name.to_s, 'synced_folders')
      return unless folders

      folders.each do |host, guest|
        config.vm.synced_folder(host, guest)
      end
    end

    def apply_chef(instance_name, config)
      if File.directory? "#{ENV['PWD']}/chef-repo/roles"
        chef_custom = instance_customization(instance_name.to_s, 'chef')
        return unless chef_custom

        chef_base_url = 'https://opscode-omnibus-packages.s3.amazonaws.com/debian/8/x86_64'
        chef_deb_file = 'chef_12.8.1-1_amd64.deb'

        config.vm.provision :shell,
                            inline: 'test -d /opt/chef ||'\
                                    "(wget #{chef_base_url}/#{chef_deb_file} -O #{chef_deb_file} && "\
                                    "dpkg -i #{chef_deb_file} && rm #{chef_deb_file})"

        config.vm.provision :chef_solo do |chef|
          chef.install = false
          chef.cookbooks_path = 'cookbooks/'
          chef.roles_path = 'chef-repo/roles'

          if chef_custom['recipes']
            chef_custom['recipes'].each do |recipe|
              chef.add_recipe(recipe)
            end
          end

          if chef_custom['roles']
            chef_custom['roles'].each do |role|
              chef.add_role(role)
            end
          end

          chef.json = chef_custom['json'] if chef_custom['json']
        end
      end
    end

    private

    def script_path(script)
      default_path = "#{ENV['PWD']}/scripts/#{script}"
      custom_path = "#{@custom['scripts_path']}/#{script}"
                    .gsub(/^~/, ENV['HOME'])

      if @custom.key?('scripts_path') \
         && ! @custom['scripts_path'].empty? && File.exist?(custom_path)
        return custom_path
      elsif File.exist?(default_path)
        return default_path
      end
      false
    end

    def instance_customization(name, key)
      if @custom.key?(name)\
         && @custom[name].key?(key)\
         && ! @custom[name][key].empty?
        return @custom[name][key]
      else
        false
      end
    end
  end
end
